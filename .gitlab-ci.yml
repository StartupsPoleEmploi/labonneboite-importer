# this part should be common and maintained in another repo
include:
  - project: lbb/devops-jobs
    file: devops.gitlab-ci.yml

# this should be the local file
python-tests:
  extends: .devops::test
  image: docker:dind
  services:
    - docker:dind-rootless
  variables:
    DOCKER_COMPOSE_FILENAME: docker-compose.testing.yml
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"

  before_script:
    - docker info
  script:
    - echo "AIRFLOW_UID=1000" > .env
    - docker volume create --name=testResults
    - docker-compose -f docker-compose.testing.yml build
    - docker-compose -f docker-compose.testing.yml run tests
    - docker run --rm -v testResults:/testResults -v $CI_PROJECT_DIR:/backup busybox tar -zcvf /backup/testResults.tar.gz /testResults
    - tar -zx -f ./testResults.tar.gz
  rules:
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TITLE !~ /Draft.*/
      changes:
        - importer/**/*
        - pyproject.toml
    - if: ( $CI_COMMIT_BRANCH == "main" &&   $CI_PIPELINE_SOURCE != 'schedule' )
      changes:
        - importer/**/*
        - pyproject.toml

sonarqube:
  extends: .devops::sonarqube
  needs:
    - job: python-tests
  rules:
    - if: ( $CI_COMMIT_BRANCH == "main"  &&   $CI_PIPELINE_SOURCE != 'schedule' )
      changes:
        - importer/**/*
        - pyproject.toml
